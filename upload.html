<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>资料上传</title>
    <!-- CSS -->
    <link rel="stylesheet" href="icofont/style.css">
    <link rel="stylesheet" href="css/style.min.css">
    <!-- JS -->
    <script type="text/javascript" src="js/system.js"></script>

</head>


<body onload="loaded()">
    <!-- footer start -->
    <footer class="navbar">
        <div class="item waves-effect" data-href="index.html">
            <i class="icon-home"></i>
            <p>首页</p>
        </div>
        <div class="item waves-effect" data-href="about.html">
            <i class="icon-star"></i>
            <p>活动介绍</p>
        </div>
        <div class="item">
            <div class="important-button active">
                <div class="important-button-wave-1"></div>
                <div class="important-button-wave-2"></div>
                <div class="important-button-bubble-1"></div>
                <div class="important-button-bubble-2"></div>
                <img class="important-button-image" src="img/important-button-1.png" alt="">
                <img class="important-button-image" src="img/important-button-upload.png" alt="">
            </div>
        </div>
        <div class="item waves-effect" data-href="news.html">
            <i class="icon-picture"></i>
            <p>活动花絮</p>
        </div>
        <div class="item waves-effect" data-href="rank.html">
            <i class="icon-group"></i>
            <p>榜单</p>
        </div>
    </footer>
    <!-- footer over -->
    <!-- main start -->
    <div class="main main-gray">
        <div class="scroller">
            <div class="spacing"></div>
            <!-- list start -->
            <div class="list list-border">
                <!-- item start -->
                <div class="item">
                    <div class="row">
                        <label class="label">姓名</label>
                        <div class="input">
                            <input class="input" type="text" placeholder="请输入参赛者姓名">
                        </div>
                    </div>
                </div>
                <!-- item over -->
                <!-- item start -->
                <div class="item">
                    <div class="row">
                        <label class="label">联系方式</label>
                        <div class="input">
                            <input class="input" type="tel" placeholder="请输入联系电话">
                        </div>
                    </div>
                </div>
                <!-- item over -->
                <!-- item start -->
                <div class="item arrow-right">
                    <div class="row">
                        <label class="label">年龄</label>
                        <div class="input">
                            <select class="select">
                                <option>5周岁</option>
                                <option>6周岁</option>
                                <option>7周岁</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- item over -->
                <!-- item start -->
                <div class="item arrow-right">
                    <div class="row">
                        <label class="label">省份</label>
                        <div class="input">
                            <select class="select" id="province" onchange="javascript:selectP(this.value);"></select>
                        </div>
                    </div>
                </div>
                <!-- item over -->
                <!-- item start -->
                <div class="item arrow-right">
                    <div class="row">
                        <label class="label">城市</label>
                        <div class="input">
                            <select class="select" id="city"></select>
                        </div>
                    </div>
                </div>
                <!-- item over -->
            </div>
            <!-- list over -->
            <div class="spacing"></div>
            <!-- list start -->
            <div class="list list-border">
                <!-- item start -->
                <div class="item" id="avatar-cropper">
                    <div class="row">
                        <label class="label">头像</label>
                        <div class="image-upload">
                            <p class="gray small">选择清晰的面部特写照片</p>
                            <div class="avatar" id="avatar-view">
                                <img class="image " id="avatar" src="img/avatar-default.png" alt="">
                                <!-- 上传后, upload 添加 uploaded -->
                                <div class="upload" id="avatar-upload">
                                    <input type="hidden" class="md-trigger" data-modal="modal-avatar">
                                    <input type="hidden" id="avatar-src" name="avatar_src">
                                    <input type="hidden" id="avatar-data" name="avatar_data">
                                    <input type="file" id="avatar-input">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- item over -->
                <!-- item start -->
                <div class="item">
                    <div class="row">
                        <label class="label">生活照</label>
                        <div class="image-upload">
                            <p class="gray small">选择1-3张照片</p>
                            <div class="photo">
                                <div class="photo-item">
                                    <div class="photo-inner" style="background-image: url('http://placehold.it/30x50');"></div>
                                    <button class="delete"><span class="icon-cancel-2"></span></button>
                                </div>
                                <div class="photo-item">
                                    <div class="photo-inner" style="background-image: url('http://placehold.it/50x30');"></div>
                                    <button class="delete"><span class="icon-cancel-2"></span></button>
                                </div>
                                <div class="upload">
                                    <i class="icon-plus"></i>
                                    <input type="file">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- item over -->
            </div>
            <!-- list over -->
            <div class="spacing"></div>
            <!-- list start -->
            <div class="list list-border">
                <!-- item start -->
                <div class="item">
                    <div class="row">
                        <label class="label top-fixed">选秀宣言</label>
                        <div class="input">
                            <textarea class="textarea" name="name" rows="3" placeholder="请输入30字以内的选秀宣言"></textarea>
                        </div>
                    </div>
                </div>
                <!-- item over -->
            </div>
            <!-- list over -->
            <!-- explain start -->
            <div class="explain align-center">
                <p class="red">错误提示</p>
            </div>
            <!-- explain over -->
            <!-- button start -->
            <div class="button-group">
                <button class="button button-block button-smooth waves-effect waves-light" data-href="upload-finish.html">
                    <span class="button-inner">提交</span>
                </button>
            </div>
            <!-- button over -->
        </div>
    </div>
    <!-- main over -->

    <!-- modal start -->
    <div class="md-modal md-effect-stick-bottom" id="modal-avatar">
        <div class="md-main">
            <!-- content start -->
            <form id="avatar-form" action="" enctype="multipart/form-data" method="post">
                <div class="modal-title">
                    <h4 class="title">上传头像</h4>
                    <button class="md-close"><i class="icon-cancel"></i></button>
                </div>
                <div class="modal-content">
                    <div class="modal-content-inner">
                        <div class="cropper-wrapper" id="modal-avatar-wrapper"></div>
                    </div>
                </div>
                <div class="modal-button-group">
                    <button class="button button-block button-smooth waves-effect" id="avatar-save">
                        <span class="button-inner">完成</span>
                    </button>
                </div>
            </form>
            <!-- content over -->
        </div>
    </div>
    <div class="md-overlay"></div>
    <!-- modal over -->

    <!-- JavaScript start -->
    <script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="js/nprogress/nprogress.js"></script>
    <script type="text/javascript" src="js/iscroll/iscroll-probe.js"></script>
    <script type="text/javascript" src="js/swiper/swiper.min.js"></script>
    <script type="text/javascript" src="js/masonry/masonry.pkgd.min.js"></script>
    <script type="text/javascript" src="js/imagesloaded/imagesloaded.pkgd.min.js"></script>
    <script type="text/javascript" src="js/modalEffects/classie.js"></script>
    <script type="text/javascript" src="js/modalEffects/modalEffects.js"></script>
    <script type="text/javascript" src="js/waves/waves.min.js"></script>
    <script type="text/javascript" src="js/scripts.js"></script>
    <!-- JavaScript over -->

    <script type="text/javascript" src="js/area/jquery.area.js"></script>
    <script type="text/javascript" src="js/cropper/cropper.min.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(function($) {

            var avatarWrapperWidth = $('#modal-avatar-wrapper').width();
            $('#modal-avatar-wrapper').css('height', avatarWrapperWidth + 'px');

            'use strict';

            var console = window.console || {
                log: function() {}
            };

            function CropAvatar($element) {

                this.$container = $element;

                this.$avatarView = $('#avatar-view'); // 表单头像容器
                this.$avatar = $('#avatar'); // 表单头像图片
                this.$avatarModal = $('#modal-avatar'); // 弹出框

                this.$loading = $('.loading');

                this.$avatarForm = $('#avatar-form'); // 弹出框form
                this.$avatarUpload = $('#avatar-upload'); // 表单头像按钮
                this.$avatarSrc = $('#avatar-src'); // 表单头像按钮src
                this.$avatarData = $('#avatar-data'); // 表单头像按钮data
                this.$avatarInput = $('#avatar-input'); // 表单头像按钮input
                this.$avatarSave = $('#avatar-save'); // 弹出框保存按钮

                this.$avatarWrapper = $('#modal-avatar-wrapper'); // 弹出框图片显示容器
                this.$avatarPreview = $('#modal-avatar-preview'); // 弹出框裁剪预览容器

                this.init();
            }

            CropAvatar.prototype = {

                constructor: CropAvatar,

                support: {
                    fileList: !!$('<input type="file">').prop('files'),
                    blobURLs: !!window.URL && URL.createObjectURL,
                    formData: !!window.FormData
                },

                init: function() {
                    this.support.datauri = this.support.fileList && this.support.blobURLs;
                    this.addListener();
                },

                addListener: function() {
                    this.$avatarView.on('click', $.proxy(this.click, this));
                    this.$avatarInput.on('change', $.proxy(this.change, this));
                    this.$avatarForm.on('submit', $.proxy(this.submit, this));
                },

                click: function() {
                    //   this.initPreview();
                },

                change: function() {
                    var files;
                    var file;
                    if (this.support.datauri) {
                        files = this.$avatarInput.prop('files');
                        if (files.length > 0) {
                            file = files[0];
                            if (this.isImageFile(file)) {
                                if (this.url) {
                                    URL.revokeObjectURL(this.url);
                                }
                                this.url = URL.createObjectURL(file);
                                this.startCropper();
                                this.$avatarModal.addClass('md-show');
                            }
                        }
                    } else {
                        file = this.$avatarInput.val();
                        this.initModal();
                        if (this.isImageFile(file)) {
                            this.syncUpload();
                        }
                    }
                },

                submit: function() {
                    if (!this.$avatarSrc.val() && !this.$avatarInput.val()) {
                        return false;
                    }
                    if (this.support.formData) {
                        // this.ajaxUpload();
                        return false;
                    }
                },

                isImageFile: function(file) {
                    if (file.type) {
                        return /^image\/\w+$/.test(file.type);
                    } else {
                        return /\.(jpg|jpeg|png|gif)$/.test(file);
                    }
                },

                startCropper: function() {
                    var _this = this;
                    if (this.active) {
                        this.$img.cropper('replace', this.url);
                    } else {
                        this.$img = $('<img src="' + this.url + '">');
                        this.$avatarWrapper.empty().html(this.$img);
                        this.$img.cropper({
                            aspectRatio: 1,
                            viewMode: 1,
                            guides: false,
                            dragMode: 'move',
                            autoCropArea: 1,
                            cropBoxMovable: false,
                            cropBoxResizable: false,
                            preview: this.$avatarPreview.selector,
                            crop: function(e) {
                                var json = [
                                    '{"x":' + e.x,
                                    '"y":' + e.y,
                                    '"height":' + e.height,
                                    '"width":' + e.width,
                                    '"rotate":' + e.rotate + '}'
                                ].join();

                                _this.$avatarData.val(json);
                            }
                        });
                        this.active = true;
                    }
                    this.$avatarModal.one('hidden.bs.modal', function() {
                        _this.$avatarPreview.empty();
                        _this.stopCropper();
                    });
                },

                stopCropper: function() {
                    if (this.active) {
                        this.$img.cropper('destroy');
                        this.$img.remove();
                        this.active = false;
                    }
                },

                syncUpload: function() {
                    this.$avatarSave.click();
                },

                submitStart: function() {
                    this.$loading.fadeIn();
                },

                submitDone: function(data) {
                    console.log(data);
                    if ($.isPlainObject(data) && data.state === 200) {
                        if (data.result) {
                            this.url = data.result;
                            if (this.support.datauri || this.uploaded) {
                                this.uploaded = false;
                                this.cropDone();
                            } else {
                                this.uploaded = true;
                                this.$avatarSrc.val(this.url);
                                this.startCropper();
                            }
                            this.$avatarInput.val('');
                        } else if (data.message) {
                            this.alert(data.message);
                        }
                    } else {
                        this.alert('Failed to response');
                    }
                },

                submitFail: function(msg) {
                    this.alert(msg);
                },

                submitEnd: function() {
                    this.$loading.fadeOut();
                },

                cropDone: function() {
                    this.$avatarForm.get(0).reset();
                    this.$avatar.attr('src', this.url);
                    this.stopCropper();
                    this.$avatarModal.removeClass('md-show');
                },

                alert: function(msg) {

                    // $('#demo-toast').on('tap', function() {
                    //     toast(msg, 3000, 'center', 'center');
                    // });
                    
                    var $alert = [
                        '<div class="alert alert-danger avatar-alert alert-dismissable">',
                        '<button type="button" class="close" data-dismiss="alert">&times;</button>',
                        msg,
                        '</div>'
                    ].join('');
                    this.$avatarUpload.after($alert);
                }

            };

            $(function() {
                return new CropAvatar($('#avatar-cropper'));
            });

        });
    </script>

</body>

</html>
